<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weather ‚Äî Dark Forecast</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
:root{--bg:#07101a;--card:#0f1b22;--muted:#9fb1bd;--accent:#3ad9c9;--shadow:0 10px 30px rgba(2,8,12,0.6)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#051018 0%,#08131a 100%);color:#e6f7f5;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1180px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 420px;gap:24px}
.header{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.search{display:flex;gap:8px;background:var(--card);padding:8px;border-radius:10px;box-shadow:var(--shadow);flex:1}
.search input{flex:1;background:transparent;border:0;padding:10px 12px;color:#dff6f2;outline:none;font-size:15px}
.search button{background:transparent;color:var(--accent);border:1px solid rgba(58,217,201,0.12);padding:9px 12px;border-radius:8px;cursor:pointer}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
.btn.active{background:linear-gradient(90deg, rgba(58,217,201,0.08), rgba(58,217,201,0.03));color:var(--accent);border-color:rgba(58,217,201,0.18)}
.left{display:flex;flex-direction:column;gap:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
.current{display:flex;gap:18px;align-items:center}
.curr-left{flex:1}
.loc{font-size:18px;font-weight:600;margin:0;color:#dff6f2}
.temp{font-size:56px;font-weight:700;margin:6px 0;color:#fff}
.cond{color:var(--muted);text-transform:capitalize}
.meta{display:flex;gap:12px;margin-top:12px;color:var(--muted);font-size:13px;flex-wrap:wrap}
.icon-wrap{text-align:center;width:140px}
.icon-wrap img{width:96px;height:96px;display:block;margin:auto}
.hourly{padding-top:8px}
.spark{width:100%;height:96px;display:block;margin-top:6px}
.hourlist{display:flex;gap:10px;margin-top:10px;overflow:auto;padding-bottom:6px}
.hcell{min-width:64px;text-align:center;color:var(--muted);font-size:13px}
.map{height:240px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
.right{display:flex;flex-direction:column;gap:18px}
.forecast-list .day{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px}
.day-left{display:flex;gap:12px;align-items:center}
.day-date{font-weight:600}
.temp-small{color:var(--muted)}
.alert{background:#102e2a;color:#73f0df;padding:10px;border-radius:8px}
.footer{color:var(--muted);font-size:13px;margin-top:8px}
@media (max-width:1000px){.container{grid-template-columns:1fr;padding:12px}.header{flex-direction:column;align-items:stretch}}
</style>
</head>
<body>
<div class="container">
  <div>
    <div class="header">
      <div class="search" onkeydown="if(event.key==='Enter')doSearch()">
        <input id="q" placeholder="Search city or coordinates or auto:ip" />
        <button id="btnSearch" onclick="doSearch()">Search</button>
      </div>
      <div class="controls">
        <button class="btn" onclick="useGeo()">üìç</button>
        <button id="unitM" class="btn active" onclick="setUnit('metric')">Metric</button>
        <button id="unitI" class="btn" onclick="setUnit('imperial')">Imperial</button>
      </div>
    </div>

    <div id="alertBar"></div>

    <div class="card current">
      <div class="curr-left">
        <div class="loc" id="loc">‚Äî</div>
        <div class="temp" id="temp">--¬∞</div>
        <div class="cond" id="cond">‚Äî</div>
        <div class="meta">
          <div>üí® <span id="wind">‚Äî</span></div>
          <div>üíß <span id="hum">‚Äî</span></div>
          <div>üå´ <span id="vis">‚Äî</span></div>
          <div>‚è± <span id="time">‚Äî</span></div>
        </div>
      </div>
      <div class="icon-wrap">
        <img id="icon" src="" alt="">
        <div style="font-size:13px;color:var(--muted);margin-top:6px" id="feels">Feels like ‚Äî</div>
      </div>
    </div>

    <div class="card hourly">
      <div style="font-weight:700">Hourly</div>
      <svg id="spark" class="spark" viewBox="0 0 800 100" preserveAspectRatio="none"></svg>
      <div class="hourlist" id="hourlist"></div>
    </div>

    <div class="card map">
      <div id="mapwrap" style="width:100%;height:100%"></div>
    </div>
  </div>

  <aside class="right">
    <div id="alerts"></div>

    <div class="card forecast-list">
      <div style="font-weight:700;margin-bottom:8px">8-day forecast</div>
      <div id="forecast"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">Air quality</div>
      <div id="aq" style="color:var(--muted)">‚Äî</div>
    </div>

    <div class="footer">simple api intergration by - YGB</div>
  </aside>
</div>

<script>
const UNIT_TOGGLE = {metric:{temp:'¬∞C',vis:'km',wind:'kph'},imperial:{temp:'¬∞F',vis:'mi',wind:'mph'}};
let UNIT='metric';
let last='auto:ip';
function el(id){return document.getElementById(id)}
function setUnit(u){UNIT=u;el('unitM').classList.toggle('active',u==='metric');el('unitI').classList.toggle('active',u==='imperial');if(last)fetchWeather(last)}
async function doSearch(){const q=el('q').value.trim()||'London';last=q;await fetchWeather(q)}
function useGeo(){if(!navigator.geolocation){alert('no geo');return}navigator.geolocation.getCurrentPosition(p=>{const q=p.coords.latitude.toFixed(4)+','+p.coords.longitude.toFixed(4);el('q').value=q;last=q;fetchWeather(q)},e=>alert(e.message),{timeout:8000})}
function showAlert(t){el('alertBar').innerHTML=`<div class="alert">${t}</div>`}
function hideAlert(){el('alertBar').innerHTML=''}
function safeIcon(u){if(!u) return '';return u.startsWith('//')? 'https:'+u:u}

async function fetchWeather(q){
  showAlert('Loading');
  try{
    const days=8;
    const res=await fetch(`/api/weather?q=${encodeURIComponent(q)}&days=${days}`);
    if(!res.ok){hideAlert();throw new Error('api');}
    const data=await res.json();
    hideAlert();
    render(data);
  }catch(e){
    hideAlert();
    el('loc').textContent='‚Äî';
    el('temp').textContent='--';
    el('cond').textContent='‚Äî';
    el('hourlist').innerHTML='';
    el('forecast').innerHTML='';
    el('mapwrap').innerHTML='';
    el('aq').textContent='‚Äî';
    showAlert('City not found or API error');
  }
}

function render(d){
  const loc=d.location;
  const cur=d.current;
  const f=d.forecast;
  el('loc').textContent=`${loc.name}, ${loc.country}`;
  el('temp').textContent=UNIT==='metric'?`${cur.temp_c}¬∞C`:`${cur.temp_f}¬∞F`;
  el('cond').textContent=cur.condition.text||'';
  el('icon').src=safeIcon(cur.condition.icon)||'';
  el('feels').textContent=UNIT==='metric'?`Feels like ${cur.feelslike_c}¬∞C`:`Feels like ${cur.feelslike_f}¬∞F`;
  el('wind').textContent=UNIT==='metric'?`${cur.wind_kph} ${cur.wind_dir}`:`${cur.wind_mph} ${cur.wind_dir}`;
  el('hum').textContent=`${cur.humidity}%`;
  el('vis').textContent=UNIT==='metric'?`${cur.vis_km} km`:`${cur.vis_miles} mi`;
  el('time').textContent=loc.localtime;

  const hours=(f.forecastday&&f.forecastday[0]&&f.forecastday[0].hour)||[];
  renderHourly(hours);
  renderMap(loc.lat,loc.lon);
  renderForecast(f.forecastday||[]);
  if(cur.air_quality) renderAQ(cur.air_quality); else el('aq').textContent='N/A';
  if(d.alerts && d.alerts.alert && d.alerts.alert.length) renderAlerts(d.alerts.alert); else el('alerts').innerHTML='';
}

function renderHourly(hours){
  el('hourlist').innerHTML='';
  const slice=hours.slice(0,12);
  if(!slice.length){el('spark').innerHTML='';return}
  const temps=slice.map(h=>UNIT==='metric'?h.temp_c:h.temp_f);
  const W=800,H=100,p=20;
  const minT=Math.min(...temps),maxT=Math.max(...temps),r=Math.max(1,maxT-minT);
  const step=(W-p*2)/(temps.length-1||1);
  const pts=temps.map((t,i)=>{const x=p+i*step;const y=p+((maxT-t)/r)*(H-p*2);return [x,y]});
  const poly=pts.map(pt=>pt.join(',')).join(' ');
  const area=[[p,H-p],...pts,[W-p,H-p]].map(p=>p.join(',')).join(' ');
  el('spark').setAttribute('viewBox',`0 0 ${W} ${H}`);
  el('spark').innerHTML=`<defs><linearGradient id="g" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#3ad9c9" stop-opacity="0.18"/><stop offset="100%" stop-color="#3ad9c9" stop-opacity="0"/></linearGradient></defs><polyline points="${poly}" fill="none" stroke="#3ad9c9" stroke-width="3" stroke-linecap="round"/><polygon points="${area}" fill="url(#g)"></polygon>`;
  slice.forEach(h=>{
    const div=document.createElement('div');div.className='hcell';
    const t=UNIT==='metric'?h.temp_c:h.temp_f;
    div.innerHTML=`<div style="font-weight:700">${t}¬∞</div><div style="font-size:12px;color:var(--muted)">${new Date(h.time).toLocaleTimeString([], {hour:'numeric',hour12:true})}</div><img src="${safeIcon(h.condition.icon)}" style="width:28px;margin-top:6px">`;
    el('hourlist').appendChild(div);
  });
}

function renderMap(lat,lon){
  const s=0.05;
  const left=(lon-s).toFixed(6),bottom=(lat-s).toFixed(6),right=(lon+s).toFixed(6),top=(lat+s).toFixed(6);
  el('mapwrap').innerHTML=`<iframe width="100%" height="100%" frameborder="0" src="https://www.openstreetmap.org/export/embed.html?bbox=${left}%2C${bottom}%2C${right}%2C${top}&layer=mapnik&marker=${lat}%2C${lon}" style="border:0"></iframe>`;
}

function renderForecast(days){
  el('forecast').innerHTML='';
  days.forEach(d=>{
    const date=new Date(d.date);const label=date.toLocaleDateString([], {weekday:'short',month:'short',day:'numeric'});
    const icon=safeIcon(d.day.condition.icon);
    const max=UNIT==='metric'?d.day.maxtemp_c:d.day.maxtemp_f;
    const min=UNIT==='metric'?d.day.mintemp_c:d.day.mintemp_f;
    const div=document.createElement('div');div.className='day';
    div.innerHTML=`<div class="day-left"><div style="width:44px;text-align:center"><img src="${icon}" width="44" height="44"></div><div><div class="day-date">${label}</div><div class="condition-small" style="color:var(--muted)">${d.day.condition.text}</div></div></div><div style="text-align:right"><div class="temp-small">${Math.round(max)} / ${Math.round(min)} ${UNIT_TOGGLE[UNIT].temp}</div></div>`;
    el('forecast').appendChild(div);
  });
}

function renderAQ(aq){
  let s='';
  if(aq['us-epa-index']!==undefined) s+=`EPA ${aq['us-epa-index']}\n`;
  if(aq.pm2_5!==undefined) s+=`PM2.5 ${aq.pm2_5.toFixed(2)} ¬µg/m¬≥\n`;
  el('aq').textContent=s||'N/A';
}

function renderAlerts(arr){el('alerts').innerHTML='';arr.forEach(a=>{const d=document.createElement('div');d.className='alert';d.innerHTML=`<strong>${a.headline||a.event}</strong><div style="color:#02332c;margin-top:6px;font-size:13px">${a.desc||a.instruction||''}</div>`;el('alerts').appendChild(d)})}

setTimeout(()=>{fetchWeather(last)},200)
</script>
</body>
</html>
